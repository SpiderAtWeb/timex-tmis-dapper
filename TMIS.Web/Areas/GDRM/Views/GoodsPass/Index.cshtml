@model GPPendingListShow

@section VendorStyles {
    <link rel="stylesheet" href="~/vendor/libs/select2/select2.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
}

@section VendorScripts {
    <script src="~/vendor/libs/toastr/toastr.js"></script>
    <script src="~/vendor/libs/select2/select2.js"></script>
}

@section PageScripts {
    <script src="~/custom/loading-hide.js"></script>
    <script src="~/js/form-layouts.js"></script>

    <script>
        $(document).ready(function () {
            $(".gp-button").on("click", function () {
                const gpId = $(this).data("id");
                const isOut = $(this).data("isout");

                $("#slectedGpId").val(gpId);
                $("#slectedGpIsOut").val(isOut);

                // Load gatepass data via AJAX
                $.ajax({
                    url: '/GDRM/GoodsPass/GetGatepassDetails',
                    method: 'GET',
                    data: { id: gpId, isOut: isOut },
                    success: function (data) {

                        // Fill alert blocks
                        $("#gpSubject").text(data.gpSubject);
                        $("#gpFrom").text(data.gpFrom);
                        $("#generatedBy").text(data.generatedBy);
                        $("#generatedDate").text(data.generatedDate);
                        $("#attention").text(data.attention);
                        $("#remarks").text(data.remarks);
                        $("#approvedBy").text(data.approvedBy);
                        $("#vehicleNo").val(data.sendVehicleId).trigger('change');
                        $("#driverName").val(data.sendDriverId).trigger('change');

                        // Fill item table
                        const tbody = $("#itemsList");


                        tbody.empty();
                        $.each(data.grGatepassDetails, function (index, item) {
                            let row = `      <div class="item-row">
                                                <div class="row align-items-center">
                                                    <div class="col-lg-2 col-md-3 mb-2">
                                                        <div class="item-badge"> ${item.itemName}</div>
                                                    </div>
                                                    <div class="col-lg-3 col-md-4 mb-2">
                                                        <div class="item-badge" style="background: rgba(102, 126, 234, 0.1); color: #667eea;">
                                                             ${item.itemDesc}
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-1 col-md-2 mb-2">
                                                        <div class="item-badge" style="background: rgba(40, 167, 69, 0.1); color: #28a745;">
                                                            ${item.quantity}
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-1 col-md-2 mb-2">
                                                        <input type="number" class="form-control quantity-input" value="${item.quantity}" min="0">
                                                    </div>
                                                    <div class="col-lg-1 col-md-1 mb-2">
                                                        <div class="item-badge" style="background: rgba(255, 193, 7, 0.1); color: #ffc107;">
                                                           ${item.gpUnits}
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-4 col-md-12 mb-2">
                                                        <select id="grGatepassDetails[${index}].ReasonId" class="form-select modern-select">
                                                            <option selected disabled>- Select Reason -</option>
                                                           ${item.grDispReasonList.map(reason => `
                                                                    <option value="${reason.value}">${reason.text}</option>
                                                                `).join('')}
                                                        </select>
                                                         <input type="hidden" id="grGatepassDetails[${index}].ID" class="issueItem-id" value="${item.id}" />
                                                    </div>
                                                </div>
                                            </div>`;
                            tbody.append(row);
                        });
                    }
                });
            });
        });
    </script>

    <script>
        $(document).ready(function () {
            $('.gp-button').on('click', function () {
                const $row = $(this).closest('tr'); // Get the row
                const gpId = $(this).data('id');    // Get the ID from the button
                const gatePassNo = $row.find('td').eq(1).text().trim(); // Get GatePassNo from 2nd <td>

                // Show loading with GatePassNo
                $("#loading-message").show().text(`Loading steps for Gate Pass: ${gatePassNo}...`);

                    $.ajax({
                  url: `/GDRM/GoodsPass/GetGatePassSteps?id=${gpId}`,
                  type: "GET",
                  success: function (data) {
                      if (data && data.length > 0) {
                          const stepsHtml = [];

                          data.forEach((step, index) => {
                              const isActive = step.stepUpdate === 1;
                              const iconClass = isActive ? "fas fa-check" : "fas fa-clock";
                              const lineHtml = index < data.length - 1 ? `<div class="step-line ${isActive ? 'active' : ''}"></div>` : "";

                              stepsHtml.push(`
                                  <div class="step-item ${isActive ? 'active' : ''}">
                                      <div class="step-circle"><i class="${iconClass}"></i></div>
                                      <div class="step-label">${step.stepLabel}</div>
                                      <div class="step-label">${step.stepText}</div>
                                      <div class="step-date">${step.stepDateTime ? new Date(step.stepDateTime).toLocaleString() : 'Pending'}</div>
                                  </div>
                                  ${lineHtml}
                              `);
                          });

                          $("#stepperSection").html(`
                              <h6 class="mb-3"><i class="fas fa-route me-2"></i>Processing Steps</h6>
                              <div class="d-flex justify-content-between align-items-center flex-wrap">
                                  ${stepsHtml.join('')}
                              </div>
                          `).fadeIn();

                          $("#loading-message").text("");
                      } else {
                          $("#loading-message").text("No steps found for Gate Pass: " + gatePassNo);
                          $("#stepperSection").hide();
                      }
                  },
                  error: function () {
                      $("#loading-message").text("Failed to load step data.");
                      $("#stepperSection").hide();
                  }
              });

            });
        });
    </script>

    <script>
        // Simulate your existing functionality with modern animations
        $(document).ready(function() {
            // Auto-click first gate pass button
            setTimeout(() => {
                $('.gp-button').first().click();
            }, 500);

            // Gate pass button click handler
            $('.gp-button').on('click', function() {
                const gpId = $(this).data('id');
                const isOut = $(this).data('isout');

                 if (isOut == 'False') {
                    $('button[data-bs-target="#receiving"]').tab('show');
                } else {
                    $('button[data-bs-target="#dispatching"]').tab('show');
                }


                // Show loading
                showLoading('Loading...');

                // Remove active class from all buttons
                $('.gp-button').removeClass('active');
                $(this).addClass('active');

                // Simulate AJAX call
                setTimeout(() => {
                    loadGatePassDetails(gpId, isOut);
                    hideLoading();
                }, 500);
            });

            // Tab switching
            $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function(e) {
                const targetTab = $(e.target).attr('data-bs-target');

                // Hide sections temporarily
                hideAllSections();

                // Remove active from all buttons
                $('.gp-button').removeClass('active');

                // Auto-click first button in active tab
                setTimeout(() => {
                    $(targetTab).find('.gp-button').first().click();
                }, 300);
            });

            // Approve/Reject handlers
            $('#approveBtn').on('click', function() {
                handleAction('approve');
            });

            $('#rejectBtn').on('click', function() {
                handleAction('reject');
            });
        });

        function showLoading(message) {
            $('#loadingMessage').text(message);
            $('#loadingOverlay').fadeIn(300);
        }

        function hideLoading() {
            $('#loadingOverlay').fadeOut(300);
        }

        function hideAllSections() {
            $( '#stepperSection, #detailsSection, #itemsSection, #actionsSection, #allgpSection').hide();
        }

        function loadGatePassDetails(gpId, isOut) {
            // Show all sections with animation
            $('#headerSection').show().addClass('animate-fadeIn');
            $('#stepperSection').show().addClass('animate-fadeIn');
            $('#detailsSection').show().addClass('animate-fadeIn');
            $('#itemsSection').show().addClass('animate-fadeIn');
            $('#actionsSection').show().addClass('animate-fadeIn');
            $('#allgpSection').show().addClass('animate-fadeIn');
        }

        function handleAction(action) {
            const actionText = action === 'approve' ? 'Approving' : 'Rejecting';
            showLoading(`${actionText}...`);

             // Collect data for Approve
                const data = {
                    gRId: parseInt($('#gRId').val()) || 0,
                    isOut: $('#slectedGpIsOut').val() == 'True' ? 1 : 0,
                    selectedGpId: parseInt($('#slectedGpId').val()) || 0,
                    vehicleNoId: parseInt($('#vehicleNo').val()) || 0,
                    driverNameId: parseInt($('#driverName').val()) || 0,
                    gPGrUpdateDetailList: [],
                    actionType: action == 'approve' ? true : false // send the action type
                };

            // Collect item data
             $('.item-row').each(function () {
                    const id = parseInt($(this).find('.issueItem-id').val()) || 0;
                    const reasonId = parseInt($(this).find('.modern-select').val()) || 0;
                    const actualQty = parseInt($(this).find('.quantity-input').val()) || 0;

                    if (id > 0 && reasonId > 0) {
                        data.gPGrUpdateDetailList.push({
                            id: id,
                            reasonId: reasonId,
                            actualQty:actualQty
                        });
                    }
                });

            // Simulate API call
                $.ajax({
                    type: 'POST',
                    url: '/GDRM/GoodsPass/GPUpdate',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function (result) {
                        if (result.isSuccess) {
                            toastr.success(result.message);
                            showSuccessMessage(result.message);
                            setTimeout(() => {
                                location.reload(); // Reload after a short delay to show the toast
                            }, 500); // 1 second delay for better user experience
                        } else {
                            toastr.error(result.message);
                            if (result.errorFieldId) {
                                var $field = $('#' + result.errorFieldId);
                                $field.addClass('input-validation-error').focus();
                            }
                        }
                    },
                    error: function () {
                        // toastr.error("Something went wrong. Please try again.");
                        showSuccessMessage("Something went wrong. Please try again.");
                    }
                });
        }

        function showSuccessMessage(message) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 end-0 m-3 p-3 bg-success text-white rounded shadow';
            toast.style.zIndex = '10000';
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle me-2"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(toast);

            // Animate in
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => {
                toast.style.transition = 'transform 0.3s ease';
                toast.style.transform = 'translateX(0)';
            }, 100);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Add some interactive micro-animations
        document.addEventListener('DOMContentLoaded', function() {
            // Add hover effects to cards
            const cards = document.querySelectorAll('.glass-card, .detail-card, .item-row');

            cards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px) scale(1.01)';
                });

                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });
        });
    </script>

}

@section PageStyles {
    <link href="~/css/gr-goods.css" rel="stylesheet" />

    <style>
      .center-badge {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 50vh; /* Full screen vertically */
  background-color: #f9f9f9; /* Optional light background */
}

.badge-message {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  background-color: #ffc107; /* Warning-like badge color */
  color: #000;
  padding: 10px 20px;
  border-radius: 25px;
  font-weight: bold;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  font-size: 1.5rem;
}

.status-indicator.status-pending {
  width: 12px;
  height: 12px;
  background-color: orange;
  border-radius: 50%;
  display: inline-block;
}

    </style>
}

@await Html.PartialAsync("_Loading")

@* ************** Content ************** *@
<!-- Ajax Sourced Server-side -->
@* <div class="panelDiv"> *@
<body>
    <div class="main-container">
        <input type="hidden" id="slectedGpId" />
        <input type="hidden" id="slectedGpIsOut" />
        <input type="hidden" asp-for="@Model.GrLocRelId" id="gRId" />
        <!-- Header -->
        <!-- Guard Room Info -->
        @{
            var pendingDispatching = Model.GPNumbersList.Where(x => x.IsOut).Take(5).ToList();
            var pendingReceiving = Model.GPNumbersList.Where(x => !x.IsOut).Take(5).ToList();
        }
        <div class="items-container animate-fadeIn" id="headerSection" style="display: none;">
            <h4 class="mb-3"><i class="fa-solid fa-person-military-pointing"></i> @Model.GRName  - GOODS GATEPASSES</h4>
            <div class="card-body mb-2">
                <!-- Tabs -->
                <ul class="nav modern-tabs animate-fadeIn" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dispatching" type="button">
                            <i class="fas fa-truck me-2"></i>Dispatching
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#receiving" type="button">
                            <i class="fas fa-dolly me-2"></i>Receiving
                        </button>
                    </li>
                </ul>
            </div>
            <div class="tab-content">
                <!-- Dispatching Tab -->
                <div class="tab-pane fade show active" id="dispatching">
                   @if (pendingDispatching.Any())
                            {
                    <div class="glass-card animate-fadeIn">
                        <div class="card-body p-2">                         
                               <h6 class="mb-1">
                                <span class="status-indicator status-pending"></span>                         
                                Pending Dispatch Gate Passes
                            </h6>                                                
                           
                            <div class="d-flex flex-wrap">
                                @foreach (var item in pendingDispatching)
                                {
                                    <button class="gp-button micro-animation" data-isout="@item.IsOut" data-id="@item.GPRouteId">
                                        <i class="fas fa-file-alt me-1"></i> @item.GPNumber
                                    </button>
                                }
                            </div>
                        </div>
                        </div>
                    }
                    else
                    {
                          <h6 class="mb-1">
                                <span class="status-indicator status-pending"></span>
                                No Any pending Dispatch Gatepasses Available
                              </h6>                 
}
                </div>

                <!-- Receiving Tab -->
                <div class="tab-pane fade" id="receiving">
                   @if (pendingReceiving.Any())
                     {
                    <div class="glass-card mb-4 animate-fadeIn">
                        <div class="card-body p-2">
                            <h6 class="mb-3">
                                <span class="status-indicator status-pending"></span>
                                Pending Receiving Gate Passes
                            </h6>
                            <div class="d-flex flex-wrap">

                                @foreach (var item in pendingReceiving)
                                {
                                    <button class="gp-button receiving micro-animation" data-isout="@item.IsOut" data-id="@item.GPRouteId">
                                        <i class="fas fa-file-import me-1"></i> @item.GPNumber
                                    </button>
                                }

                            </div>
                        </div>                        
                    </div>
                     }
                      else
                    {
                          <h6 class="mb-1">
                                <span class="status-indicator status-pending"></span>
                                No Any pending Receive Gatepasses Available
                            </h6>              
                    
}
                </div>
            </div>
        </div>
             

        @if (pendingDispatching.Any() || pendingReceiving.Any())
        {    <!-- Stepper Section -->
            <div class="stepper-container animate-fadeIn" id="stepperSection" style="display: none;">
                <h6 class="mb-3"><i class="fas fa-route me-2"></i>Processing Steps</h6>
            </div>

            <!-- Gate Pass Details -->
            <div class="items-container animate-fadeIn" id="detailsSection" style="display: none;">
                <div class="gradient-header">
                    <h6><i class="fas fa-info-circle me-2"></i>Gate Pass Details</h6>
                </div>
                <div class="card-body">
                    <div class="details-grid">
                        <div class="detail-card micro-animation">
                            <div class="detail-label">Gate Pass Subject</div>
                            <div class="detail-value" id="gpSubject"></div>
                        </div>
                        <div class="detail-card micro-animation">
                            <div class="detail-label">Generated By</div>
                            <div class="detail-value" id="generatedBy"></div>
                        </div>
                        <div class="detail-card micro-animation">
                            <div class="detail-label">Attention</div>
                            <div class="detail-value" id="attention"></div>
                        </div>
                        <div class="detail-card micro-animation">
                            <div class="detail-label">Approved By</div>
                            <div class="detail-value" id="approvedBy"></div>
                        </div>
                        <div class="detail-card micro-animation">
                            <div class="detail-label">Remarks</div>
                            <div class="detail-value" id="remarks"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Items List -->
            <div class="items-container animate-fadeIn" id="itemsSection" style="display: none;">
                <h6 class="mb-3"><i class="fas fa-list me-2"></i>Gate Pass Items</h6>
                <div id="itemsList">
                </div>
            </div>

            <!-- Transport & Actions -->
            <div class="items-container animate-fadeIn" id="actionsSection" style="display: none;">
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-4 mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-truck me-1"></i>Vehicle Number
                            </label>
                            <select asp-items="@Model.GPVehicleNoList" class="select2 form-select" id="vehicleNo">
                                <option selected disabled>- Select Vehicle -</option>
                            </select>
                        </div>
                        <div class="col-4 mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-user me-1"></i>Driver Name
                            </label>
                            <select asp-items="@Model.GPDriversList" class="select2 form-select" id="driverName">
                                <option selected disabled>- Select Driver -</option>
                            </select>
                        </div>
                        <div class="col-4 mb-3">
                            <div class="action-buttons">
                                <button class="modern-btn btn-approve flex-fill" id="approveBtn">
                                    <i class="fas fa-check me-2"></i>Approve
                                </button>
                                <button class="modern-btn btn-reject flex-fill" id="rejectBtn">
                                    <i class="fas fa-times me-2"></i>Reject
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- All Gate Passes -->
            <div class="items-container mb-4 animate-fadeIn" id="allgpSection" style="display: none;">
            <div class="card-body">
                <h6 class="mb-3"><i class="fas fa-list-ul me-2"></i>All Pending Gate Passes</h6>
                <div class="d-flex flex-wrap">

                    @foreach (var item in Model.GPNumbersList.Skip(5))
                    {
                        var buttonClass = item.IsOut ? "" : "receiving";

                        <button type="button"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="@item.GpTo"
                                class="gp-button micro-animation @buttonClass"
                                data-isout="@item.IsOut"
                                data-no="@item.GPNumber"
                                data-id="@item.GPRouteId">
                            @item.GPNumber
                        </button>
                    }
                </div>
            </div>
        </div>
        }
        else
        {
            <div class="center-badge">
              <h6 class="badge-message">
                <span class="status-indicator status-pending"></span>
                No Pending Dispatch/Receive Gate Passes Available.
              </h6>
            </div>

        }

    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="text-center text-white">
            <div class="loading-spinner mb-3"></div>
            <h5 id="loadingMessage">Loading...</h5>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="floating-action" onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </button>
</body>
