@model EmpPendingListShow

@section VendorStyles {
    <link rel="stylesheet" href="~/vendor/libs/select2/select2.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
}

@section VendorScripts {
    <script src="~/vendor/libs/toastr/toastr.js"></script>
    <script src="~/vendor/libs/select2/select2.js"></script>
}

@section PageScripts {
    <script src="~/custom/loading-hide.js"></script>
    <script src="~/js/form-layouts.js"></script>

    <script>
        $(document).ready(function () {
            $(".gp-button").on("click", function () {
                const gpId = $(this).data("id");
                const isOut = $(this).data("isout");

                $("#selectedEmpGpId").val(gpId);
                $("#selectedEmpGpIsOut").val(isOut);

                // Load gatepass data via AJAX
                $.ajax({
                    url: '/GDRM/EmployeePass/GetEmployeeGatepassDetails',
                    method: 'GET',
                    data: { id: gpId, isOut: isOut },
                    success: function (data) {

                        // Fill alert blocks
                        $("#empGpNo").text(data.empGpNo);
                        $("#gateName").text(data.gateName)
                        $("#expLoc").text(data.expLoc);
                        $("#expReason").text(data.expReason);
                        $("#expOutTime").text(data.expOutTime ? new Date(data.expOutTime).toLocaleString() : '');
                        $("#genUser").text(data.genUser);
                        $("#responsedBy").text(data.responsedBy);
                        $("#responsedDateTime").text(data.responsedDateTime);
                        $("#isReturn").text(data.isReturn);

                        // Fill item table
                        const tbody = $("#itemsList");


                        tbody.empty();
                        $.each(data.empGatepassDetails, function (index, item) {
                            let row = `      <div class="item-row">
                                                <div class="row align-items-center">
                                                    <div class="col-5 mb-2">
                                                        <div class="item-badge">${item.empName}</div>
                                                    </div>
                                                    <div class="col-5 mb-2">
                                                        <div class="item-badge" style="background: rgba(102, 126, 234, 0.1); color: #667eea;">
                                                             ${item.empEPF}
                                                        </div>
                                                    </div>                                                  
                                                    <div class="col-2 mb-2">
                                                          <input id="empGatepassDetails[${index}].actualTime" class="form-control time-val" type="time" id="html5-time-input" />
                                                          <input type="hidden" id="empGatepassDetails[${index}].id" class="employee-id" value="${item.id}" />
                                                    </div>
                                                </div>
                                            </div>`;
                            tbody.append(row);
                        });
                    }
                });
            });
        });
    </script>

    <script>
        // Simulate your existing functionality with modern animations
        $(document).ready(function() {
            // Auto-click first gate pass button
            setTimeout(() => {
                $('.gp-button').first().click();
            }, 500);

            // Gate pass button click handler
            $('.gp-button').on('click', function() {
                const gpId = $(this).data('id');
                const isOut = $(this).data('isout');

                 if (isOut == 'False') {
                    $('button[data-bs-target="#receiving"]').tab('show');
                } else {
                    $('button[data-bs-target="#dispatching"]').tab('show');
                }


                // Show loading
                showLoading('Loading...');

                // Remove active class from all buttons
                $('.gp-button').removeClass('active');
                $(this).addClass('active');

                // Simulate AJAX call
                setTimeout(() => {
                    loadGatePassDetails(gpId, isOut);
                    hideLoading();
                }, 500);
            });

            // Tab switching
            $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function(e) {
                const targetTab = $(e.target).attr('data-bs-target');

                // Hide sections temporarily
                hideAllSections();

                // Remove active from all buttons
                $('.gp-button').removeClass('active');

                // Auto-click first button in active tab
                setTimeout(() => {
                    $(targetTab).find('.gp-button').first().click();
                }, 300);
            });

            // Approve/Reject handlers
            $('#approveBtn').on('click', function() {
                handleAction('approve');
            });

            $('#rejectBtn').on('click', function() {
                handleAction('reject');
            });
        });

        function showLoading(message) {
            $('#loadingMessage').text(message);
            $('#loadingOverlay').fadeIn(300);
        }

        function hideLoading() {
            $('#loadingOverlay').fadeOut(300);
        }

        function hideAllSections() {
            $( '#detailsSection, #itemsSection, #actionsSection, #allgpSection').hide();
        }

        function loadGatePassDetails(gpId, isOut) {
            // Show all sections with animation
            $('#headerSection').show().addClass('animate-fadeIn');
            $('#detailsSection').show().addClass('animate-fadeIn');
            $('#itemsSection').show().addClass('animate-fadeIn');
            $('#actionsSection').show().addClass('animate-fadeIn');
            $('#allgpSection').show().addClass('animate-fadeIn');
        }

        function handleAction(action) {
            const actionText = action === 'approve' ? 'Approving' : 'Rejecting';
            showLoading(`${actionText}...`);

             // Collect data for Approve
                const data = {
                    gRId: parseInt($('#gRId').val()) || 0,
                    isOut: $('#selectedEmpGpIsOut').val() == 'True' ? 1 : 0,
                    selectedEmpGpId: parseInt($('#selectedEmpGpId').val()) || 0,
                    empGpUpdateDetailList: [],
                    actionType: action == 'approve' ? true : false // send the action type
                };

            // Collect item data
             $('.item-row').each(function () {
                    const id = parseInt($(this).find('.employee-id').val()) || 0;
                    const timeValue = parseInt($(this).find('.time-val').val()) || '';


                    if (id > 0) {
                        data.empGpUpdateDetailList.push({
                            id: id,
                            timeValue: timeValue
                        });
                    }
                });

            // Simulate API call
                $.ajax({
                    type: 'POST',
                    url: '/GDRM/EmployeePass/EmpGPUpdate',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function (result) {
                        if (result.isSuccess) {
                            toastr.success(result.message);
                            showSuccessMessage(result.message);
                            setTimeout(() => {
                                location.reload(); // Reload after a short delay to show the toast
                            }, 500); // 1 second delay for better user experience
                        } else {
                            toastr.error(result.message);
                            if (result.errorFieldId) {
                                var $field = $('#' + result.errorFieldId);
                                $field.addClass('input-validation-error').focus();
                            }
                        }
                    },
                    error: function () {
                        // toastr.error("Something went wrong. Please try again.");
                        showSuccessMessage("Something went wrong. Please try again.");
                    }
                });
        }

        function showSuccessMessage(message) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 end-0 m-3 p-3 bg-success text-white rounded shadow';
            toast.style.zIndex = '10000';
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle me-2"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(toast);

            // Animate in
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => {
                toast.style.transition = 'transform 0.3s ease';
                toast.style.transform = 'translateX(0)';
            }, 100);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Add some interactive micro-animations
        document.addEventListener('DOMContentLoaded', function() {
            // Add hover effects to cards
            const cards = document.querySelectorAll('.glass-card, .detail-card, .item-row');

            cards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px) scale(1.01)';
                });

                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });
        });
    </script>

}

@section PageStyles {
    <link href="~/css/gr-goods.css" rel="stylesheet" />
        <style>
      .center-badge {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 50vh; /* Full screen vertically */
        background-color: #f9f9f9; /* Optional light background */
      }

      .badge-message {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background-color: #ffc107; /* Warning-like badge color */
        color: #000;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: bold;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        font-size: 1.5rem;
      }

      .status-indicator.status-pending {
        width: 12px;
        height: 12px;
        background-color: orange;
        border-radius: 50%;
        display: inline-block;
      }

    </style>
}

@await Html.PartialAsync("_Loading")

@* ************** Content ************** *@
<!-- Ajax Sourced Server-side -->
@* <div class="panelDiv"> *@
<body>
    <div class="main-container">
        <input type="hidden" id="selectedEmpGpId" />
        <input type="hidden" id="selectedEmpGpIsOut" />
        <input type="hidden" asp-for="@Model.GrLocRelId" id="gRId" />
        <!-- Header -->
        <!-- Guard Room Info -->
        @{
            var pendingDispatching = Model.EmpNumbersList.Where(x => x.IsOut).Take(5).ToList();
            var pendingReceiving = Model.EmpNumbersList.Where(x => !x.IsOut).Take(5).ToList();
        }
        <div class="items-container animate-fadeIn" id="headerSection" style="display: none;">
            <h4 class="mb-3"><i class="fa-solid fa-person-military-pointing"></i> @Model.GRName  - EXIT PERMITS</h4>
            <div class="card-body mb-2">
                <!-- Tabs -->
                <ul class="nav modern-tabs animate-fadeIn" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dispatching" type="button">
                            <i class="fas fa-truck me-2"></i>OUT
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#receiving" type="button">
                            <i class="fas fa-dolly me-2"></i>IN
                        </button>
                    </li>
                </ul>
            </div>
            <div class="tab-content">
                <!-- Dispatching Tab -->
                <div class="tab-pane fade show active" id="dispatching">
                   @if (pendingDispatching.Any())
                            {
                    <div class="glass-card animate-fadeIn">
                        <div class="card-body p-2">                         
                               <h6 class="mb-1">
                                <span class="status-indicator status-pending"></span>                         
                                Pending OUT Exit Permits
                            </h6>                                                
                           
                            <div class="d-flex flex-wrap">
                                @foreach (var item in pendingDispatching)
                                {
                                    <button class="gp-button micro-animation" data-isout="@item.IsOut" data-id="@item.EmpGpId">
                                        <i class="fas fa-file-alt me-1"></i> @item.EmpGpNumber
                                    </button>
                                }
                            </div>
                        </div>
                        </div>
                    }
                    else
                    {
                          <h6 class="mb-1">
                                <span class="status-indicator status-pending"></span>                         
                                No Any pending OUT Exit Permits Available
                            </h6>                 
}
                </div>

                <!-- Receiving Tab -->
                <div class="tab-pane fade" id="receiving">
                   @if (pendingReceiving.Any())
                     {
                    <div class="glass-card mb-4 animate-fadeIn">
                        <div class="card-body p-2">
                            <h6 class="mb-3">
                                <span class="status-indicator status-pending"></span>
                                Pending IN Exit Permits
                            </h6>
                            <div class="d-flex flex-wrap">

                                @foreach (var item in pendingReceiving)
                                {
                                    <button class="gp-button receiving micro-animation" data-isout="@item.IsOut" data-id="@item.EmpGpId">
                                        <i class="fas fa-file-import me-1"></i> @item.EmpGpNumber
                                    </button>
                                }

                            </div>
                        </div>                        
                    </div>
                     }
                      else
                    {
                          <h6 class="mb-1">
                                <span class="status-indicator status-pending"></span>                         
                                No Any pending IN Exit Permits Available
                            </h6>              
                    
}
                </div>
            </div>
        </div>
             

        @if (pendingDispatching.Any() || pendingReceiving.Any())
        {
          <!-- Gate Pass Details -->
            <div class="items-container animate-fadeIn" id="detailsSection" style="display: none;">
                <div class="gradient-header">
                    <h6><i class="fas fa-info-circle me-2"></i>Exit Permit Details</h6>
                </div>
                <div class="card-body">
                    <div class="details-grid">
                        <div class="detail-card micro-animation">
                            <div class="detail-label">Gate Name</div>
                            <div class="detail-value" id="gateName"></div>
                        </div>
                        <div class="detail-card micro-animation">
                            <div class="detail-label">Location</div>
                            <div class="detail-value" id="expLoc"></div>
                        </div>
                        <div class="detail-card micro-animation">
                            <div class="detail-label">Reason</div>
                            <div class="detail-value" id="expReason"></div>
                        </div>
                        <div class="detail-card micro-animation">
                            <div class="detail-label">OUT Time</div>
                            <div class="detail-value" id="expOutTime"></div>
                        </div>
                        <div class="detail-card micro-animation">
                            <div class="detail-label">Generated By</div>
                            <div class="detail-value" id="genUser"></div>
                        </div>
                        <div class="detail-card micro-animation">
                            <div class="detail-label">Approved By</div>
                            <div class="detail-value" id="responsedBy"></div>
                        </div>
                         <div class="detail-card micro-animation">
                            <div class="detail-label">Approved Date Time</div>
                            <div class="detail-value" id="responsedDateTime"></div>
                        </div>
                          <div class="detail-card micro-animation">
                            <div class="detail-label">Is Return</div>
                            <div class="detail-value" id="isReturn"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Items List -->
            <div class="items-container animate-fadeIn" id="itemsSection" style="display: none;">
                <h6 class="mb-3"><i class="fas fa-list me-2"></i>Exit Permit Employees</h6>
                <div id="itemsList">
                </div>

                 <div class="col-4 mb-3 offset-8">
                            <div class="action-buttons">
                                <button class="modern-btn btn-approve flex-fill" id="approveBtn">
                                    <i class="fas fa-check me-2"></i>Approve
                                </button>
                                <button class="modern-btn btn-reject flex-fill" id="rejectBtn">
                                    <i class="fas fa-times me-2"></i>Reject
                                </button>
                            </div>
                  </div>
            </div>          

            <!-- All Gate Passes -->
            <div class="items-container mb-4 animate-fadeIn" id="allgpSection" style="display: none;">
            <div class="card-body">
                <h6 class="mb-3"><i class="fas fa-list-ul me-2"></i>All Pending Gate Passes</h6>
                <div class="d-flex flex-wrap">

                    @foreach (var item in Model.EmpNumbersList.Skip(5))
                    {
                        var buttonClass = item.IsOut ? "" : "receiving";

                        <button type="button"
                                class="gp-button micro-animation @buttonClass"
                                data-isout="@item.IsOut"
                                data-no="@item.EmpGpNumber"
                                data-id="@item.EmpGpId">
                            @item.EmpGpNumber
                        </button>
                    }
                </div>
            </div>
        </div>
        }
        else
        {
              <div class="center-badge">
              <h6 class="badge-message">
                <span class="status-indicator status-pending"></span>
                No Pending In/Out Exit Permits Available.
              </h6>
            </div>
        }

    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="text-center text-white">
            <div class="loading-spinner mb-3"></div>
            <h5 id="loadingMessage">Loading...</h5>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="floating-action" onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </button>
</body>
