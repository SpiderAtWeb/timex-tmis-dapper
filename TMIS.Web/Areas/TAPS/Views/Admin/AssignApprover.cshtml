@using TMIS.Models.TAPS.VM
@model AssignApproverVM

@section VendorStyles {
	<link rel="stylesheet" href="~/vendor/libs/datatables-bs5/datatables.bootstrap5.css">
	<link href="~/vendor/libs/toastr/toastr.css" rel="stylesheet" />
	<link rel="stylesheet" href="~/vendor/libs/select2/select2.css" />
}

@section VendorScripts {
	<script src="~/vendor/libs/flatpickr/flatpickr.js"></script>
	<script src="~/vendor/libs/select2/select2.js"></script>
}

@section PageStyles {

	<style>
		#userDetailTable {
			width: 100%;
			margin: 0 auto;
			font-size: 0.95rem;
			background-color: #fff;
			border-radius: 8px;
			overflow: hidden;
			box-shadow: 0 2px 8px rgba(0,0,0,0.04);
		}

			#userDetailTable th, #userDetailTable td {
				padding: 0.4rem 0.75rem;
			}

			#userDetailTable th {
				background-color: #f8f9fa;
				color: #495057;
				font-weight: 600;
			}

			#userDetailTable td {
				vertical-align: middle;
			}
	</style>
}

@section PageScripts {
	<script src="~/vendor/libs/toastr/toastr.js"></script>
	<script src="~/custom/tables-datatables-mc-request.js"></script>
	<script src="~/custom/loading-hide.js"></script>

	@if (TempData["success"] != null)
	{
		<script src="~/vendor/libs/toastr/toastr.js"></script>
		<script type="text/javascript">
			toastr.success('@TempData["success"]');
		</script>
		TempData.Clear();
	}
	@if (TempData["error"] != null)
	{
		<script src="~/vendor/libs/toastr/toastr.js"></script>
		<script type="text/javascript">
			toastr.success('@TempData["error"]');
		</script>
		TempData.Clear();
	}

	<script>

		$('.select2').select2({
		  placeholder: "- Select -",
		  allowClear: true
		});

		let unassignUserId = null;
		let unassignUserRoleId = null;
		$(document).ready(function () {
			$('#EmpNameDropdown').on('change', function () {
				$('#userDetailContainer').empty();
				const userId = $(this).val();
				if (!userId) return;

				$.get(`/TAPS/Admin/GetApprovers?userId=${userId}`, function (data) {					
					let rowsHtml = '';
					if (Array.isArray(data) && data.length > 0) {
						data.forEach(function (item) {
							rowsHtml += `<tr>
								<td>${item.userEmail ?? ''}</td>
								<td>${item.username ?? ''}</td>
								<td>${item.approverEmail ?? ''}</td>
								<td>${item.approvername ?? ''}</td>
								<td>${item.systemType ?? ''}</td>
								<td>
								  <button type="button" class="btn btn-danger btn-sm unassign-btn"
									data-userid="${item.userId}"
									data-approverid="${item.appUserId}"
									data-systemtype="${item.systemType}">
									Remove
								  </button>
								</td>
							</tr>`;
						});
					} else {
						rowsHtml = `<tr><td colspan="6" class="text-center">No Approvers found for this user.</td></tr>`;
					}
					$('#userDetailContainer').html(rowsHtml);
				});
			});

			$('#userDetailContainer').on('click', '.unassign-btn', function () {
				unassignUserId = $(this).data('userid');
				unassignApproverId = $(this).data('approverid');
				systemType = $(this).data('systemtype');
				if (!unassignUserId || !unassignApproverId || !systemType) return;
				console.log("inapprove")
				// Show Bootstrap modal
				var unassignModal = new bootstrap.Modal(document.getElementById('unassignModal'));
				setTimeout(() => {
					unassignModal.show();
				}, 50);
			});

			// Handle confirm button click in modal
			$('#confirmUnassignBtn').on('click', function () {
				if (!unassignUserId || !unassignApproverId || !systemType) return;

				$.ajax({
					url: '/TAPS/Admin/UnAssignApprover',
					type: 'POST',
					data: {
						userId: unassignUserId,
						approverId: unassignApproverId,
						systemType: systemType
					},
					success: function (result) {
						$('#EmpNameDropdown').trigger('change'); // Refresh the table
						toastr.success('Approver removed successfully.');
					},
					error: function () {
						toastr.error('Failed to remove approver.');
					},
					complete: function () {
						// Hide modal after action
						var unassignModal = bootstrap.Modal.getInstance(document.getElementById('unassignModal'));
						unassignModal.hide();
					}
				});
			});
		});
	</script>
}

@await Html.PartialAsync("_Loading")

<div class="card mb-6">
	<h5 class="card-header page-header">
		Assign Approver
	</h5>
	<form asp-action="AssignApprover" method="post" class="card-body" id="myForm">
		<div class="row g-1">
			<div class="col-md-3">
				<div class="form-floating form-floating-outline">
					<select asp-for="@Model.selectedUserID" asp-items="@Model.UserList" id="EmpNameDropdown" class="select2 form-select" data-allow-clear="true">
						<option value="" Disabled Selected>- Select User -</option>
					</select>

					<label asp-for="selectedUserID"></label>
					<span asp-validation-for="selectedUserID" class="text-warning"></span>
				</div>
			</div>
			<div class="col-md-3">
				<div class="form-floating form-floating-outline">
					<select asp-for="@Model.selectedApproverID" asp-items="@Model.UserList" class="select2 form-select" data-allow-clear="true">
						<option value="" Disabled Selected>- Select Approver -</option>
					</select>

					<label asp-for="selectedApproverID"></label>
					<span asp-validation-for="selectedApproverID" class="text-warning"></span>
				</div>
			</div>
			<div class="col-md-3">
				<div class="form-floating form-floating-outline">
					<select asp-for="@Model.selectedSystemTypeID" asp-items="@Model.SystemTypeList" class="select2 form-select" data-allow-clear="true">
						<option value="" Disabled Selected>- Select System Type -</option>
					</select>

					<label asp-for="selectedSystemTypeID"></label>
					<span asp-validation-for="selectedSystemTypeID" class="text-warning"></span>
				</div>
			</div>
			<div class="pt-1">
				<button type="submit" class="btn btn-primary me-1">Assign</button>
			</div>
			<div class="card" id="userDetailsField">
				<div class="card-body">
					<div class="row g-4">
						<div class="col-12">
							<table class="table table-bordered table-sm table-striped table-hover align-middle" id="userDetailTable">
								<thead>
									<tr>
										<th>User Email</th>
										<th>User Name</th>
										<th>Approver Email</th>
										<th>Approver Name</th>
										<th>System Type</th>
										<th>Action</th>
									</tr>
								</thead>
								<tbody id="userDetailContainer">
									<!-- Dynamic content will go here -->
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- Unassign Confirmation Modal -->
		<div class="modal fade" id="unassignModal" tabindex="-1" aria-labelledby="unassignModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="unassignModalLabel">Confirm Remove</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						Are you sure you want to remove this approver?
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
						<button type="button" class="btn btn-danger" id="confirmUnassignBtn">Remove</button>
					</div>
				</div>
			</div>
		</div>
	</form>
</div>
